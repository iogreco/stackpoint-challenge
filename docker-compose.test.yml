# Override for E2E testing
# Use with: docker compose -f docker-compose.yml -f docker-compose.test.yml up
# Uses a dedicated Postgres volume so stackpoint_test is created on first run.

services:
  # Use test database (separate volume so stackpoint_test exists; base compose uses "stackpoint")
  postgres:
    environment:
      POSTGRES_DB: stackpoint_test
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stackpoint_user -d stackpoint_test"]

  # Enable controlled failures for testing
  worker-text-extractor:
    environment:
      ENABLE_CONTROLLED_FAILURES: "true"

  worker-pdf-fallback:
    environment:
      ENABLE_CONTROLLED_FAILURES: "true"

  worker-persistence:
    environment:
      ENABLE_CONTROLLED_FAILURES: "true"
      DATABASE_URL: postgresql://stackpoint_user:stackpoint_pass@postgres:5432/stackpoint_test

  query-api:
    environment:
      DATABASE_URL: postgresql://stackpoint_user:stackpoint_pass@postgres:5432/stackpoint_test

volumes:
  postgres_test_data:
    driver: local
